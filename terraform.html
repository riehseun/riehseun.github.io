<!DOCTYPE html>

<html lang="en">

<head>

<!-- Metadata -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="Seungmoon Rieh">
<meta name="keywords" content="">

<!-- Title and image -->
<title>Seungmoon Rieh</title>
<link href="img/seungmoonrieh.jpg" rel="icon">

<!-- CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/monokai-sublime.css" rel="stylesheet">
<link href="css/site.css" rel="stylesheet">

<!-- JavaScript -->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/highlight.pack.js"></script>
<script type="text/javascript" src="js/include_html.js"></script>
<script type="text/javascript" src="js/site.js"></script>

</head>

<body>

<include src="header.html"></include>

<div class="container">
<div class="row">
<div class="col-md-12">
<h1 class="my-4">Software Engineering</h1>

<!-- Terraform BEGIN -->
<div class="card mb-4" id="terraform">
  <div class="card-body">
    <h2 class="card-title">Terraform</h2>
    <ul class="list-unstyled mb-0">
      <li><a href="#terraform-1">Terraform with Google Cloud</a></li>
      <li><a href="#terraform-2">Terraform on GCP - Kubernetes</a></li>
      <li><a href="#terraform-3">Terraform on GCP - storage</a></li>
      <li><a href="#terraform-4">Terraform with GCP - common errors</a></li>
      <li><a href="#terraform-5">Install Terraform (version 0.11.13) in CentOS</a></li>
      <li><a href="#terraform-6">Terraform on AWS</a></li>
    </ul>
  </div>
</div>

<div class="card mb-4" id="terraform-1">
  <div class="card-body">
    <h2 class="card-title">Terraform basic</h2>
    <p class="card-text"></p>

    <ul>
      <li>Terraform "state" allows tracking changes in resources.</li>
      <li>Terraform plugins are call "providers", which let Terraform interact with cloud providers via their APIs.</li>
    </ul>

    <h3 class="card-title">Command</h3>
    <ul>
      <li>terraform init: install plugins.</li>
      <li>terraform plan: preview the change.</li>
      <li>terraform apply: make the planned changes.</li>
      <li>terraform destroy (this command tears down instances deployed)</li>
    </ul>

    <h3 class="card-title">Installation (Ubuntu)</h3>
<pre><code class="bash">sudo apt-get install -y gnupg software-properties-common

wget -O- https://apt.releases.hashicorp.com/gpg | \
gpg --dearmor | \
sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg

echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
    https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
    sudo tee /etc/apt/sources.list.d/hashicorp.list

sudo apt-get install terraform

terraform -v</code></pre>
  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://learn.hashicorp.com/">Hashcorp learn</a>
  </div>
</div>

<div class="card mb-4" id="terraform-2">
  <div class="card-body">
    <h2 class="card-title">Terraform on GCP - Kubernetes</h2>

    <h3 class="card-title">Example: main.tf</h3>
<pre><code class="bash">provider "google" {
  credentials = "${file("../../googlecloud/credential.json")}"
  project     = "${var.project}"
}

module "vpc" {
  source                 = "../modules/global"
  var_env                = "${var.env}"
  var_company            = "${var.company}"
  var_region_name        = "${var.region_name}"
  var_ue1_public_subnet  = "${var.ue1_public_subnet}"
  var_ue1_private_subnet = "${var.ue1_private_subnet}"
}

module "ue1" {
  source                 = "../modules/ue1"
  var_env                = "${var.env}"
  var_company            = "${var.company}"
  var_region_name        = "${var.region_name}"
  var_ue1_public_subnet  = "${var.ue1_public_subnet}"
  var_ue1_private_subnet = "${var.ue1_private_subnet}"
  network_self_link      = "${module.vpc.vpc_self_link}"
  subnetwork1            = "${module.ue1.public_subnet_name}"
}</code></pre>

    <h3 class="card-title">Example: vpc.tf</h3>
<pre><code class="bash">resource "google_compute_network" "vpc" {
  name                    = "${format("%s","${var.var_company}-vpc")}"
  auto_create_subnetworks = "false"
  routing_mode            = "GLOBAL"
}

resource "google_compute_firewall" "allow-internal" {
  name    = "${var.var_company}-fw-allow-internal"
  network = "${google_compute_network.vpc.name}"
  allow {
    protocol = "icmp"
  }
  allow {
    protocol = "tcp"
    ports    = ["0-65535"]
  }
  allow {
    protocol = "udp"
    ports    = ["0-65535"]
  }
}

resource "google_compute_firewall" "allow-http" {
  name    = "${var.var_company}-fw-allow-http"
  network = "${google_compute_network.vpc.name}"
  allow {
    protocol = "tcp"
    ports    = ["80"]
  }
  target_tags = ["http"]
}

resource "google_compute_firewall" "allow-bastion" {
  name    = "${var.var_company}-fw-allow-bastion"
  network = "${google_compute_network.vpc.name}"
  allow {
    protocol = "tcp"
    ports    = ["22"]
  }
  target_tags = ["ssh"]
}</code></pre>

    <h3 class="card-title">Example: network.tf</h3>
<pre><code class="bash">resource "google_compute_subnetwork" "public_subnet" {
  name          = "${format("%s","${var.var_company}-${var.var_env}-${var.var_region_name}-pub-net")}"
  ip_cidr_range = "${var.var_ue1_public_subnet}"
  network       = "${var.network_self_link}"
  region        = "${var.var_region_name}"
}

resource "google_compute_subnetwork" "private_subnet" {
  name          = "${format("%s","${var.var_company}-${var.var_env}-${var.var_region_name}-pri-net")}"
  ip_cidr_range = "${var.var_ue1_private_subnet}"
  network       = "${var.network_self_link}"
  region        = "${var.var_region_name}"
}</code></pre>

    <h3 class="card-title">Example: instance.tf</h3>
<pre><code class="bash">resource "google_compute_instance" "vm1" {
  name          = "k8s-master"
  machine_type  = "n1-standard-2"
  zone          = "${format("%s","${var.var_region_name}-c")}"

  tags          = ["ssh","http"]

  boot_disk {
    initialize_params {
      image = "centos-7-v20180129"
    }
  }

  metadata {
    foo = "bar"
  }

  network_interface {
    subnetwork = "${google_compute_subnetwork.public_subnet.name}"

    access_config {
      // Ephemeral IP
    }
  }

  provisioner "remote-exec" {
    # You cannot open interactive session with "sudo -i". You must also run all yum commands with -y flag
    inline = [
      "sudo yum install ansible -y"
    ]

    connection {
      host        = "${self.network_interface.0.access_config.0.nat_ip}"
      type        = "ssh"
      user        = "${var.ssh_user}"
      private_key = "${file("~/.ssh/id_rsa")}"
    }
  }

  provisioner "local-exec" {
    # Environment variable can be used inside ansible playbook
    environment {
      PUBLIC_IP                 = "${self.network_interface.0.access_config.0.nat_ip}"
      HOSTNAME                  = "k8s-master"
      ANSIBLE_HOST_KEY_CHECKING = false # This is must to avoid the error "The authenticity of host can't be established"
    }

    # You must install "ansible" on the machine where terraform-ansible suites get executed
    # Add "-vvv" for verbose output
    command     = "ansible-playbook -u ${var.ssh_user} --private-key ~/.ssh/id_rsa ../ansible/k8s-master.yaml -i $PUBLIC_IP,"
  }
}</code></pre>

  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://medium.com/slalom-technology/a-complete-gcp-environment-with-terraform-c087190366f0">A complete GCP environment with Terraform</a>
  </div>
</div>

<div class="card mb-4" id="terraform-3">
  <div class="card-body">
    <h2 class="card-title">Terraform with GCP - storage</h2>

<pre><code class="bash"># Create a GCS Bucket
resource "google_storage_bucket" "my_bucket" {
  name     = var.bucket_name
  location = var.region
}

resource "google_pubsub_topic" "example" {
  name = "example-topic"
}

resource "google_pubsub_topic_iam_member" "member" {
  project = google_pubsub_topic.example.project
  topic = google_pubsub_topic.example.name
  role = "roles/viewer"
  member = "user:jane@example.com"
}

resource "google_storage_notification" "notification" {
  bucket         = google_storage_bucket.bucket.name
  payload_format = "JSON_API_V1"
  topic          = google_pubsub_topic.topic.id
  event_types    = ["OBJECT_FINALIZE"]
}</code></pre>
  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://pbhadani.com/posts/first-gcp-resource-with-terraform/">Create a Google Cloud Storage(GCS) Bucket with Terraform</a> | <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/pubsub_topic">google_pubsub_topic</a> | <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/pubsub_topic_iam">IAM policy for Cloud Pub/Sub Topic</a> | <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/storage_notification">google_storage_notification</a>
  </div>
</div>

<div class="card mb-4" id="terraform-4">
  <div class="card-body">
    <h2 class="card-title">Terraform with GCP - common errors</h2>
    <ul>
      <li><strong>"Invalid JWT: Token must be a short-lived token (60 minutes) and in a reasonable timeframe</strong> - This happens when the date and time of OS is out of sync. Run <strong>date +%T -s "10:13:13"</strong> [10: Hour (hh) 13: Minute (mm) 13: Second (ss)] to update it.</li>
    </ul>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="terraform-5">
  <div class="card-body">
    <h2 class="card-title">Install Terraform (version 0.11.13) in CentOS</h2>
    <ul>
      <li>yum install -y zip unzip</li>
      <li>wget https://releases.hashicorp.com/terraform/0.9.8/terraform_0.11.13_linux_amd64.zip</li>
      <li>unzip terraform_0.11.13_linux_amd64.zip</li>
      <li>mv terraform /usr/local/bin/</li>
      <li>terraform --version</li>
    </ul>
  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://linuxacademy.com/community/posts/show/topic/18181-can-somebody-explain-how-to-install-terraform">Linux Academy</a>
  </div>
</div>

<div class="card mb-4" id="terraform-6">
  <div class="card-body">
    <h2 class="card-title">Terraform on AWS</h2>
    <p class="card-text"></p>

    <h3 class="card-title">How to get access key</h3>
    <img class="img-fluid" class="card-img-top" src="img/terraform/terraform1.png" alt="Card image cap">
    <img class="img-fluid" class="card-img-top" src="img/terraform/terraform2.png" alt="Card image cap">
    <br>
    <br>

<pre><code class="bash">export AWS_ACCESS_KEY_ID=
export AWS_SECRET_ACCESS_KEY=</code></pre>

    <h3 class="card-title">main.tf</h3>
<pre><code class="bash">terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 4.16"
    }
  }

  required_version = ">= 1.2.0"
}

provider "aws" {
  region  = "us-west-2"
}

resource "aws_instance" "app_server" {
  ami           = "ami-830c94e3"
  instance_type = "t2.micro"

  tags = {
    Name = var.instance_name
  }
}</code></pre>

<h3 class="card-title">variable.tf</h3>
<pre><code class="bash">variable "instance_name" {
  description = "Value of the Name tag for the EC2 instance"
  type        = string
  default     = "ExampleAppServerInstance"
}</code></pre>

<pre><code class="bash">terraform init
terraform fmt
terraform validate
terraform apply

# Inspects state.
terraform show

#
terraform output</code></pre>

  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://learn.hashicorp.com/">Hashcorp learn</a>
  </div>
</div>
<!-- Terraform END -->

</div> <!-- /.col-md-12 -->
</div> <!-- /.row -->
</div> <!-- /.container -->

<include src="footer.html"></include>

</body>

</html>