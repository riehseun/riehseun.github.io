<!DOCTYPE html>

<html lang="en">

<head>

<!-- Metadata -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Seungmoon's DevOps Engineering Blog">
<meta name="author" content="Seungmoon Rieh">
<meta name="keywords" content="Python, Groovy, Kubernetes, Docker, Jenkins, Terraform, Bash">

<!-- Title and image -->
<title>Seungmoon Rieh</title>
<link href="img/seungmoonrieh.jpg" rel="icon">

<!-- CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/monokai-sublime.css" rel="stylesheet">
<link href="css/site.css" rel="stylesheet">

<!-- JavaScript -->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/highlight.pack.js"></script>
<script type="text/javascript" src="js/include_html.js"></script>
<script type="text/javascript" src="js/site.js"></script>

</head>

<body>

<include src="header.html"></include>

<div class="container">
<div class="row">
<div class="col-md-12">
<h1 class="my-4">Software Engineering</h1>

<!-- Jenkins BEGIN -->
<div class="card mb-4" id="jenkins">
  <div class="card-body">
    <h2 class="card-title">Jenkins (Groovy)</h2>
    <ul class="list-unstyled mb-0">
      <li><a href="#jenkins-1">Jenkins Infrastrue</a></li>
      <li><a href="#jenkins-2">Set up Jenkins master on Linux</a></li>
      <li><a href="#jenkins-3">Set up Jenkins agent on Linux</a></li>
      <li><a href="#jenkins-4">Groovy Basic (used in Jenkins pipeline)</a></li>
      <li><a href="#jenkins-5">DSL (domain specific language)</a></li>
      <li><a href="#jenkins-7">Pipeline and DSL</a></li>
        <ul>
          <li><a href="#jenkins-7-1">Pipeline - Maven</a></li>
          <li><a href="#jenkins-7-2">Pipeline - Nexus</a></li>
          <li><a href="#jenkins-7-3">Pipeline - Bitbucket</a></li>
          <li><a href="#jenkins-7-4">Pipeline - Email</a></li>
          <li><a href="#jenkins-7-5">Pipeline - SonarQube</a></li>
          <li><a href="#jenkins-7-6">Pipeline - Sonatype</a></li>
          <li><a href="#jenkins-7-7">Pipeline - Veracode</a></li>
          <li><a href="#jenkins-7-8">Pipeline - SOA Test</a></li>
          <li><a href="#jenkins-7-9">Pipeline - Run Jenkins Job</a></li>
        </ul>
          <li><a href="#jenkins-8">Pipeline using shared library</a></li>
          <li><a href="#jenkins-9">Multibranch Pipeline</a></li>
          <li><a href="#jenkins-10">Multibranch Pipeline with shared library</a></li>
          <ul>
            <li><a href="#jenkins-10-1">Pipeline with Shared Library - Job Configuration</a></li>
            <li><a href="#jenkins-10-2">Pipeline with Shared Library - Architecture 1</a></li>
            <li><a href="#jenkins-10-3">Pipeline with Shared Library - Architecture 2</a></li>
            <li><a href="#jenkins-10-4">Pipeline with Shared Library - Architecture 3</a></li>
            <li><a href="#jenkins-10-5">Pipeline with Shared Library - Architecture 4</a></li>
            <li><a href="#jenkins-10-6">Pipeline with Shared Library - Builder</a></li>
            <li><a href="#jenkins-10-7">Pipeline with Shared Library - Builder - MavenBuild</a></li>
            <li><a href="#jenkins-10-8">Pipeline with Shared Library - Builder - NodeBuild</a></li>
            <li><a href="#jenkins-10-9">Pipeline with Shared Library - Builder - AngularPackage</a></li>
            <li><a href="#jenkins-10-10">Pipeline with Shared Library - Publisher</a></li>
            <li><a href="#jenkins-10-11">Pipeline with Shared Library - Publisher - MavenPublish</a></li>
            <li><a href="#jenkins-10-12">Pipeline with Shared Library - Publisher - MavenRelease</a></li>
            <li><a href="#jenkins-10-13">Pipeline with Shared Library - Publisher - AngularPublish</a></li>
            <li><a href="#jenkins-10-14">Pipeline with Shared Library - Deployer</a></li>
            <li><a href="#jenkins-10-15">Pipeline with Shared Library - Notifier</a></li>
            <li><a href="#jenkins-10-16">Pipeline with Shared Library - Notifier - SCMNotification</a></li>
            <li><a href="#jenkins-10-17">Pipeline with Shared Library - Notifier - EmailNotification</a></li>
            <li><a href="#jenkins-10-18">Pipeline with Shared Library - Scanner</a></li>
          </ul>
          <li><a href="#jenkins-11">Maven and pom.xml</a></li>
          <li><a href="#jenkins-12">Common Jenkins pipeline issues and resolutions</a></li>
          <li><a href="#jenkins-13">Jenkins job DSL scripts</a></li>
    </ul>
  </div>
</div>

<div class="card mb-4" id="jenkins-1">
  <div class="card-body">
    <h2 class="card-title">Jenkins Infrastrue</h2>
    <p class="card-text">Jenkins infrastructure will have <Strong>Master</Strong> and <strong>Agents</strong></p>

    <h3 class="card-title">Jenkins master</h3>
    <ul>
      <li>Contains
        <ul>
          <li>Seed job that runs DSL scripts</li>
          <li>Plugins</li>
        </ul>
      </li>
      <li>Must have enough disk space to host growing number of job and plugins.</li>
      <li>Data is critical and must be backed up regularly. (If using cloud, consider persistent volume)</li>
    </ul>

    <h3 class="card-title">Jenkins agent</h3>
    <ul>
      <li>Contains
        <ul>
          <li>Workspaces where files will be pulled-in and jobs will run.</li>
          <li>Tools to run the jobs such as maven, npm, etc.</li>
        </ul>
      </li>
      <li>Data is not critical because they can always be pulled-in from the job configurations.</li>
      <li>And workspaces can always be deleted and recreated.</li>
      <li>Agents can be linux or windows. Jobs can be configured to run on a specific agent. Pipeline jobs can run different steps on different agent.</li>
    </ul>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-2">
  <div class="card-body">
    <h2 class="card-title">Set up Jenkins master on Linux</h2>
    <p class="card-text"></p>
    <ul>
      <li>Download "jenkins.war", installed it, and access Jenkins UI via [ip]:8080</li>
      <li>Specify the port in which Jenkins master should talk to its agent. Jenkins->Configure GLobal Security->TCP port for JNLP agents-> Fixed:8443</li>
      <li>Set the # of executor of master at 0 so that no builds run on master. Jenkins->Nodes->master-># of executors:0</li>
      <li>Configure authentication strategy.
        <ul>
          <li>For exmaple, Jenkins->Configure Global Security->Security Realm: Active Directory, Authorization:Role-Based Strategy</li>
        </ul>
      </li>
    </ul>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-3">
  <div class="card-body">
    <h2 class="card-title">Set up Jenkins agent on Linux</h2>
    <p class="card-text"></p>
    <ul>
        <li>You can specify number of executors, directory of workspace, way to launch the agent</li>
    </ul>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-4">
  <div class="card-body">
    <h2 class="card-title">Groovy Basic (used in Jenkins pipeline)</h2>
<pre><code class="groovy">// Groovy common imports
import com.cloudbees.groovy.cps.NonCPS
import groovy.json.JsonBuilder
import groovy.json.JsonOutput
import groovy.json.JsonSlurper
import groovy.json.JsonSlurperClassic

// Groovy commenting
/**
* Description about the method
* @param param1 description about param1
*        param2 description about param2
* @return return value
*/

// "NonCPS" annotation
// This annotation will tell Groovy not to Serialize the method. During the code execution, unserialized code may not be interruptable.
// This annotation is used for example when a method is called instande a constructor, when working with file stream, etc.</code></pre>

<pre><code class="groovy">// Groovy map example.
Map map = [
    key: [
        subkey1: "value"
        subkey2: [
            subsubkey1: "value",
            subsubkey2: "value"
        ]
    ]
]

// Initialize a map.
Map map = [:]

// Loop through a map.
map.each {
    // do something with "it" (for example, "it.key" and "it.value")
}

// Find the value by key in a map.
map.find { it.key.toString().trin() == "key" }?.value

// Check if a map/dictionary contains a key.
if (dict.containsKey()) {

}

// Add to a map/dictionary.
dict.put("key", "value")</code></pre>

<pre><code class="groovy">// Find files in the current directory.
findFiles(glob: '*.yaml')

// Check if file exists.
def absolutePath = "absolute path of the file"
File file = new File(absolutePath)
file.exists()

// Create a file with content.
writeFile(file: "fileName", text: fileContent)

// Read a file into a variable.
readFile "fileName"</code></pre>

<pre><code class="groovy">// Convert YAML to JSON.
def absolutePath = "absolute path of the YAML file"
def fileInYaml = readYaml file: absolutePath
def fileInJson = new JsonBuilder(fileInYaml).toPrettyString()

// Convert JSON string to JSON object.
jsonObject = new JsonSlurperClassic().parseText(jsonString)

// Convert JSON object to JSON string.
jsonString = new JsonBuilder(jsonObject).toPrettyString()

// Create a JSON string.
String json = new JsonBuilder([
    field1: value1,
    field2: value2,
    field3: value3
]).toString()</code></pre>

<pre><code class="groovy">// Loop through a list.
for (i in list) {
    // do something with "i"
}

// Convert String to a list.
String myListInString = "['first', 'second', 'third']"
def myList = myListInString[1..-2].split(', ')</code></pre>

<pre><code class="groovy">// In-line if/else: If a is null, b is assgiend. Else, c is assigned.
def val = (a == null) ? b : c

// Break the outerloop in a nested loop.
loop:
for (foo in foos) {
    for (var in vars) {
        if (condition) {
            break loop
        }
    }
}</code></pre>

<pre><code class="groovy">// Switch
switch(variable) {
    case "value1":
        // Do something.
        break
    case "value2":
        // Do something.
        break
    default:
        // Do something.
}</code></pre>

<pre><code class="groovy">// Pipeline methods
stage("stage name")
dir("directory name")
withEnv(["ENV_VAR_NAME1=${variable1}", "ENV_VAR_NAME2=${variable2}"])
withCredentials([usernamePassword(credentialsId: credentialObjectId, passwordVariable: "PASSWORD",  usernameVariable: "USERNAME")])

String credentialId = scm.getUserRemoteConfigs()[0].getCredentialsId()
sshagent([credentialId])

env.getProperty("string_parameter") // Get the value of a parameter to a Jenkins Job</code></pre>

<pre><code class="groovy">// Http request plugin
httpRequest(
    authentication: credentialObjectId,
    contentYpe: "APPLICATION_JSON",
    httpMode: "GET",
    customHeaders: "",
    url: "",
    ignoreSslErrors: true
)

// Downloads a file
httpRequest(
    url "",
    responseHandle: "NONE",
    outputFile: "",
    timeout: ""
)</code></pre>

<pre><code class="groovy">// Bash integration
String variable = sh returnStdout: true, script: 'some bash command'</code></pre>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-5">
  <div class="card-body">
    <h2 class="card-title">DSL (domain specific language)</h2>
    <h3 class="card-title">How to create Jenkins job</h3>
    <p class="card-text">Create jobs by executing "Jenkinsfile" from a seeder job.</p>
    <p class="card-text">Define the job.</p>
<pre><code class="groovy">pipelineJob("pathToJob") {
    def releaseRef = "master" // Or can be "refs/tags/&lt;version&gt;"
    logRotator {
        numToKeep(10) // Keep only 10 builds in the history.
    }
    parameters {
        StringParam('parameterName', 'defaultValue', 'description')
        ...
    }
    environmentVariables {
        keepSystemVariables(true)
        keepBuildVariables(true)
        envs (
            'NAME_OF_ENV_VAR': 'VALUE_OF_ENV_VAR'
        )
    }
    description("Description of Jenkins job")
    definition {
        cpsSCM  {
            scm {
                git {
                    remote {
                        url('gitCloneUrl')
                        credentials('nameOfCredentialObject')
                    }
                    branch('*/master') // Or can be "refs/tags/&lt;version&gt;"
                    extensions {
                        cloneOptions {
                            honorRefspec(true)
                        }
                    }
                }
            }
            scriptPath('pathToPipelineScript')
        }
    }
}</code></pre>

    <p class="card-text">Write the script that the Job runs.</p>
<pre><code class="groovy">@Library('name-of-your-lib@version') _
import path.to.utils.Utils

// This logic runs on Jenkins master.
node () {
    timestamps { // Enable time stamps on console output.
        wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'XTerm']) {
            stage("Name of your stage") {
                ...
            }
        }
    }
}

// This logic runs on Jenkins agent with the match label.
node (label) {
    timestamps {
        try {
            wrap([$class: 'AnsiColorBuildWrapper', 'colorMapName': 'XTerm']) {
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'nameOfCredentialObject', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
                    dir() { // Change directory.
                        stage("Name of your stage") {
                            ...
                        }
                    }
                }
            }
        }
    }
}</code></pre>

    <p class="card-text">Library should look like this.</p>
<pre><code class="groovy">package path.to.utils

public class Utils implements Serializable {

    def context

    public Utils(def context) {
        this.context = context
    }

    ...
</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7">
  <div class="card-body">
    <h2 class="card-title">Pipeline and DSL</h2>
    <p class="card-text">Jenkins pipeline is a tool to implement CI/CD. DSL (Domain Specifc Language) is the programming language used to write the Jenkins pipeline.</p>
    <p class="card-text">DSL has many keywords. For example,</p>
    <ul>
      <li>dir - specifies workspace in which the code runs</li>
      <li>stage - defines each pipeline stage, which are deplayed on Jenkins UI</li>
      <li>sh - can execute bash commands</li>
      <li>withCredentials - can read credentials from Credential Store of Jenkins</li>
      <li>withEnv - can set Environment variables when running commands</li>
    </ul>
    <p class="card-text">All key words must be written inside <strong>node</strong> block. Otherwise, pipeline would throw compilation error.</p>

<pre><code class="groovy">node {

    dir()

    stage()

    sh

}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-1">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Maven</h2>
    <p class="card-text">Maven operations examples</p>

<pre><code class="groovy">stage("Maven Build") {
    withEnv(["PATH=WHATEVER=PATH_TO_MAVEN:PATH_TO_JDK"]) {
        sh """ mvn clean install -B """
    }
}

stage("Maven Publish") {
    withEnv(["PATH=WHATEVER=PATH_TO_MAVEN:PATH_TO_JDK"]) {
        sh """ mvn deploy -DskipTests -B """
    }
}

stage("Maven Release") {
    withEnv(["PATH=WHATEVER=PATH_TO_MAVEN:PATH_TO_JDK"]) {
        sh """ mvn -B release:prepare release:perform """
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-2">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Nexus</h2>
    <p class="card-text">Download the latest artfact from Nexus</p>

<pre><code class="groovy">stage("Download latest artifact from Nexus") {
    // These parameters would be specific to artifact you are trying to download
    String nexusUrl = "YOUR_NEXUS_URL"
    String repository = "YOUR_REPOSITORY"
    String groupId = "YOUR_GROUP_ID"
    String artifactId = "YOUR_ARTICAT_ID"
    String packaging = "PACKAGING"

    // Build Nexus end-point using artifact-specific parameters
    String nexusLink = nexusUrl+"/"+repository+"/"+groupId.replace(".","/")+"/"+artifactId
    sh """
        # querying artifact's metadata and
        response=\$(curl --silent --compressed ${nexusLink}/maven-metadata.xml)
        # parsing xml response to get the version number
        version=\$(grep -oPm1 '(?>=&lt;release&gt;)[^<]+' <<< \$response)
        # downloading the artifact
        wget --no-check-certificate --output-document $DIRECTORY_TO_PLACE_ARTIFACT ${nexusLink}/\$version/${artifactId}-\$version.${packaging}
    """
}</code></pre>

    <p class="card-text">Upload an artfact to Nexus</p>

<pre><code class="groovy">stage("Upload artifact to Nexus") {
    sh """
        mvn deploy:deploy-file -Dfile=YOUR_FILE -DgroupId=YOUR_GROUP_ID -DartifactId=YOUR_ARTIFACT_ID -Dversion=YOUR_VERSION -Dpackaging=YOUR_PACKAGING -DgeneratePom=true -DcreateChecksum=true -DrepositoryId=releases -Durl=YOUR_NEXUS_URL_INCLUDING_AUTHENTICATION_AND_PATH_TO_REPOSITORY
    """
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-3">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Bitbucket</h2>
    <p class="card-text">Send build status to Jenkins (Requires "http_request" plugin)</p>

<pre><code class="groovy">stage("Notify Bitbucket") {
    String commitHash = sh returnStdout: true, script 'git rev-parse HEAD'
    String shortCommitHash = sh returnStdout: true, script 'git rev-parse --short HEAD'
    def requestBody = new JsonBuilder([
        state: "YOUR_STATE" // can be one of SUCCESSFUL, IN PROGRESS, STOPPED, FAILED
        key: env.BRANCH_NAME + "-" + shortCommitHash
        url: env.BUILD_URL
    ])
    // Be careful about the endpoint
    String requestUrl = "YOUR_BITBUCKET_URL" + "/rest/build-status/1.0/commits/" + commitHash
    def response = httpRequest authentication: "YOUR_BITBUCKET_CREDENTIAL", contentType: "APPLICATION_JSON", httpMode: "POST", requestBody: requestBody, url: requestUrl
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-4">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Email</h2>
    <p class="card-text">Send an email (Requires "email-ext" plugin)</p>

<pre><code class="groovy">stage("Send Email") {
    mail bcc: "", body: YOUR_EMAIL_BODY, cc: "", from: "", replyTo: "", subject: YOUR_SUBJECT, to: YOUR_EMAIL_LIST
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-5">
  <div class="card-body">
    <h2 class="card-title">Pipeline - SonarQube</h2>
    <p class="card-text">SONARQUBE_ENVIRONMENT must be set up in the Jenkins (Manage Jenkins -> Configure System). You need supply information such as Sonarqube server url, authentication token, etc</p>

    <p class="card-text">Execute SonarQube scan and get the result (Requires "sonar-maven-plugin")</p>

<pre><code class="groovy">stage("SonarQube") {
    withSonarQubeEnv("SONARQUBE_ENVIRONMENT") {
        withEnv(["PATH=WHATEVER=PATH_TO_MAVEN:PATH_TO_JDK"]) {
            sh """
                mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.3.0.603:sonar -B
            """
        }
    }
    def sonarQubeScanResult = waitForQualityGate()
    println sonarQubeScanResult
}</code></pre>

    <p class="card-text">If not using Maven, you can use sonar-scanner package. In this case, you need to have project properties file in the code repository</p>

<pre><code class="groovy">stage("SonarQube") {
    withSonarQubeEnv("SONARQUBE_ENVIRONMENT") {
        withEnv(["PATH=WHATEVER=PATH_TO_SONAR_SCANNER"]) {
            sh """
                sonar-scanner -Dsonar.projectBaseDir=$DIRECTORY_WHERE_PROJECT_PROPERTIES_IS_LOCATED
            """
        }
    }
    def sonarQubeScanResult = waitForQualityGate()
    println sonarQubeScanResult
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-6">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Sonatype</h2>
    <p class="card-text">Execute Sonatype scan (Requires "nexus-jenkins-plugin")</p>

<pre><code class="groovy">stage("SonaType") {
    def result = nexusPolicyEvaluation failBuildOnNetworkError: false, iqApplication: "YOUR_SONATYPE_APP_ID", iqStage: "SonaType", jobCredentialsId: ""
    if (result != null) {
        def criticalIssues = policyEvaluationResult.criticalComponentCount
        def severeIssues = policyEvaluationResult.severeComponentCount
        def moderateIssues = policyEvaluationResult.moderateComponentCount
        println criticalIssues
        println severeIssues
        println moderateIssues
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-7">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Veracode</h2>
    <p class="card-text">Execute Veracode scan (Requires "veracode-jenkins-plugin")</p>

<pre><code class="groovy">stage("Veracode") {
    withCredentials([usernamePassword(credentialsId: '', passwordVariable: 'VERACODE_PASSWORD', usernameVariable: 'VERACODE_USERNAME')]) {
        veracode applicationName: "YOUR_VERACODE_APP_ID", canFailJob: false, createSandBox: true, criticality: "veryhigh", debug: true, sandboxName: "YOUR_VERACODE_SANDBOX_ID", vuser: env.VERACODE_USERNAME, vpassword: env.VERACODE_PASSWORD
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-8">
  <div class="card-body">
    <h2 class="card-title">Pipeline - SOA Test</h2>
    <p class="card-text">This would only work on a Windows agent.</p>

<pre><code class="groovy">stage("SOA Test") {
    withEnv(["SOATESTPATH=PATH_TO_SOA, SOA_LOCATION=YOUR_SOA_TEST_FOLDER_LOCATION, OPTIONS=YOUR_SOA_TEST_OPTIONS"]) {
        bat '''
            "%SOATESTPATH%\\soatestcli.exe" -data %WORKSPACE% -import %WORKSPACE%\\%SOA_LOCATION%\\.project
            "%SOATESTPATH%\\soatestcli.exe" -data %WORKSPACE% -resource %SOA_LOCATION% -config "user://Example Configuration" %YOUR_SOA_TEST_OPTIONS%
        '''
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-7-9">
  <div class="card-body">
    <h2 class="card-title">Pipeline - Run Jenkins Job</h2>
    <p class="card-text"></p>

<pre><code class="groovy">stage("Run Jenkins Job") {
    Map jobParameterMap = [[$class: 'StringParameterValue', name: 'PARAMETER_NAME1', value: 'PARAMETER_VALUE1'], [$class: 'StringParameterValue', name: 'PARAMETER_NAME2', value: 'PARAMETER_VALUE2']]
    def result = build job: PATH_TO_YOUR_JOB, parameters: evaluate(jobParameterMap), wait: true
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-8">
  <div class="card-body">
    <h2 class="card-title">Pipeline using shared library</h2>
    <p class="card-text">Instead of writing DSL directly into Jenkins jobs, you can store DSL in a repository and call them from Jenkins jobs. This is the idea of "shared library" and its structure should be the following.</p>
    <img class="img-fluid" class="card-img-top" src="img/jenkins/jenkins-8-a.png" alt="Card image cap">
    <br>
    <br>

    <p class="card-text">Note that the pipeline steps under "var" folder must implement "call" method. Each pipeline step should begin with/</p>

<pre><code class="groovy">#!/usr/bin/groovy
def call(body) {
    // Code goes here
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-9">
  <div class="card-body">
    <h2 class="card-title">Multibranch Pipeline</h2>
    <p class="card-text">Multibranch pipeline allows Jenkins to build jobs <strong>automatically</strong> whenever any change in a branch of code repository is detected by the <strong>Jenkinsfile</strong>. This <strong>Jenkinsfile</strong> should be located in the root of code repository.</p>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10">
  <div class="card-body">
    <h2 class="card-title">Multibranch Pipeline with Shared Library</h2>
    <p class="card-text">Multibranch pipeline is where the use of "shared library" becomes a MUST. First of all, the <strong>Jenkinsfile</strong> in the root of code repository should look like.</p>

<pre><code class="bash"># NAME_OF_SHARED_LIBRARY should be set in Manage Jenkins -> Configure System
# NAME_OF_BRANCH should be set to a branch used for productionalized code (usually such branch is "master")
# "mainMethod" must be a pipeline step from the shared library. It is a good practice to pass in the name of repository so that repository-specific configuration can be read when executing the pipeline
#!groovy
@Library("NAME_OF_SHARED_LIBRARY@NAME_OF_BRANCH")
mainMethod("NAME_OF_CODE_REPOSITORY")</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-1">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Job Configuration</h2>
    <p class="card-text">Implementation of <strong>resources/com/rieh/jenkins/maven-project/project.yaml</strong></p>

<pre><code class="bash">agent: 'LINUX-AGENT'
tools: ['jdk','maven']
workflow:
branch: 'develop'
steps:
- mavenBuild:
agent: 'LINUX-AGENT'
stage_name: 'MAVEN BUILD'
checkout_scm: true
clean_up_workspace: false
mvn_command: 'mvn clean install'
- sonarQubeScan:
agent: 'LINUX-AGENT'
stage_name: 'SONARQUBE SCAN'
checkout_scm: false
clean_up_workspace: false
sonarqube_strategy: 'MAVEN'
- sonatypeScan:
agent: 'LINUX-AGENT'
stage_name: 'SONATYPE SCAN'
checkout_scm: false
clean_up_workspace: false
sonatype_application_id: 'CFP'
- veracodeScan:
agent: 'LINUX-AGENT'
stage_name: 'VERACODE SCAN'
checkout_scm: false
clean_up_workspace: false
veracode_application_id: ''
veracode_sandbox_id: ''
veracode_upload_pattern: '**/target/**.war'
veracode_wait_for_completion: false
- mavenPublish:
agent: 'LINUX-AGENT'
stage_name: 'MAVEN PUBLISH'
checkout_scm: false
clean_up_workspace: false
mvn_command: 'mvn deploy -DskipTests -B'
version_strategy: 'PATCH'
- jbossDeploy:
agent: 'LINUX-AGENT'
stage_name: 'JBOSS DEPLOY'
checkout_scm: false
clean_up_workspace: false
deployment_env: 'DEV'
deployment_target: ''
deployment_artifact: 'target/**.war'
- soaTest:
agent: 'SOA-AGENT'
stage_name: 'SOA TEST'
checkout_scm: true
clean_up_workspace: true
test_soa_scripts: ''
test_soa_options: ''
- notification:
agent: 'LINUX-AGENT'
stage_name: 'EMAIL NOTIFICATION'
checkout_scm: false
clean_up_workspace: false
notification_type: 'EMAIL'
notification_email_sender: ''
notification_email_recipients: ''</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-2">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Architecture 1</h2>
    <p class="card-text">We want to treat <strong>Jenkinsfile</strong> as a kind of configuration file that projects can choose during runtime. Thus, the content of <strong>Jenkinsfile</strong> should be minimized so that major logic is handled in the main method.</p>
    <p class="card-text">There are many things to do in the main methods. First of all, we want to identify the project by parsing the SCM url so that we can pick the right configuration file for that project.</p>

<pre><code class="groovy">String scmUrl = this.scm.getUserRemoteConfigs()[0].getUrl()
String scmName = scmUrl.split("/")[scmUrl.split("/").size()-1].replace(".git", "")</code></pre>

    <p class="card-text">Then, we want to go ahead to grap the configuration file for the project. There will always be two kinds of configuration file: 1. Global config that applies to all projects 2. Project config, which is specific for the project and can overide the global config during runtime. The following step shows how these two configs can be consolidated.</p>

<pre><code class="groovy">node {
    String globalConfigString = this.libraryResource("com/rieh/jenkins/util/default_settings.yaml")
    String projectConfigString = this.libraryResource("com/rieh/jenkins/$scmName/jenkinsConfig.yaml")
    this.writeFile file: "global_config", text: globalConfigString
    this.writeFile file: "project_config", text: projectConfigString
    Map globalConfig = this.readYaml file: "global_config"
    Map projectConfig = this.readYaml file: "project_config"
    config = com.rieh.jenkins.util.Utilities.reconcileConfig(projectConfig, globalConfig)
}</code></pre>

    <p class="card-text">Next step is to find the pipeline workflow for the current branch. We also need to consider the case where there are default steps to run when the pipeline workflow for the current branch is not defined in the project configuration file.</p>

<pre><code class="groovy">Map config = null
Map workflow = null
Map defaultWorkflow = null
String currentBranch = env.BRANCH_NAME.split('/')[0]

currentBuild.result = "SUCCESS"
for (wf in config.workflow) {
    if (wf.branch == currentBranch) {
        workflow = wf
    }
    else if (wf.branch == config.default_branch) {
        defaultWorkflow = wf
    }
}
if (workflow == null) {
    if (defaultWorkflow == null) {
        currentBuild.result = "ABORTED"
        return // exit pipeline prematurely
    }
    else {
        workflow = defaultWorkflow
    }
}</code></pre>

    <p class="card-text">It is possible that you have multiple Jenkins masters with different Jenkins version and different sets of plugins. This means the syntax of shared pipeline library may work in one Jenkins master but not in the others. Thus, you would need "feature toggle" for the code base such that different methods are triggered depending on which Jenkins master that the code is running. To to so, we first need to identify the Jenkins master.</p>

<pre><code class="groovy">String internalHostname = InetAddress.localHost.canonicalHostName
switch(internalHostName) {
    case "[internalHostName1]":
    config.pipeline_version = "v1"
    break
    case "[internalHostName2]":
    config.pipeline_version = "v2"
    break
    default:
    currentBuild.result = "ABORTED"
    return // exit pipeline prematurely
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-3">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Architecture 2</h2>
    <p class="card-text">Here we write Utilities class the provide "static" methods.</p>

<pre><code class="groovy">package com.rieh.jenkins.util
import java.util.Map

@Singleton
public class Utilities {

}</code></pre>

    <p class="card-text">The implementation of "reconcileConfig" methods from the "mainMethod.groovy" is given here.</p>

<pre><code class="groovy">public static Map reconcileConfig(Map projectConfig, Map globalConfig) {
    if (projectConfig == null) {
        return globalConfig
    }
    else {
        Map config = globalConfig.clone()
        for (item in projectConfig) {
            config[item.key] = projectConfigp[item.key]
        }
        return config
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-4">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Architecture 3</h2>
    <p class="card-text">To structure the shared pipeline library, we will need an abstract class that represents what we are trying to do. We are really writing pipeline steps, so lets create an abstract class "Step". Implemeting the interface "Serializable" is very important when writing Jenkins pipeline, which we will explore in a separate section.</p>

<pre><code class="groovy">package com.rieh.jenkins
public abstract class Step implements Serializable {

}</code></pre>

    <p class="card-text">On top of declaring variables and abstract methods, we want to have some methods that can be used by children classes that extends it. (Thus the "protected" scope) An example of useful method is to run Bash or Shell command depending on which OS the command is run.</p>

<pre><code class="groovy">protected void runOsCMD(Object scope, String command) {
    if (scope.isUnix()) {
        scope.sh(command)
    } else {
        scope.bat(command)
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-5">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Architecture 4</h2>
    <p class="card-text">We also need a class that will produce reports on execution of Jenkins pipeline. This report can be sent via email after each pipeline workflow finishes.</strong></p>

<pre><code class="groovy">package com.rieh.jenkins.util

  @Singleton
  public class Reporter {

}</code></pre>

    <p class="card-text">This class should contain methods such as.</p>

<pre><code class="groovy">public static void setupReporting(Object scope) {
    scope.writeFile file: 'reporting/build_report.html', text: ""
    scope.stach includes: 'reporting/*', name: java.net.URLDecoder.decode(scope.env.BUILD_TAG).replace('/','-')
}</code></pre>

<pre><code class="groovy">public static void addToReport(Object scope, String report, String agent) {
    scope.unstash name: java.net.URLDecoder.decode(scope.env.BUILD_TAG).replace('/','-')
    def appender = scope.readFile file: 'reporting/build_report.html'
    appender += report
    scope.writeFile file: 'reporting/build_report.html', text: appender
    scope.stash includes: 'reporting/*', name: java.net.URLDecoder.decode(scope.env.BUILD_TAG).replace('/','-')
}</code></pre>

<pre><code class="groovy">public static String consolidateReport(Object scope) {
    scope.unstash name: java.net.URLDecoder.decode(scope.env.BUILD_TAG).replace('/','-')
    def report = this.openReport(scope)
    report += scope.readFile('reporting/build_report.html')
    report += this.closeReport()
    scope.stash includes: 'reporting/*', name: java.net.URLDecoder.decode(scope.env.BUILD_TAG).replace('/','-')

    return report
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-6">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Builder</h2>
    <p class="card-text">"Building the code package" is one of the initial steps for the pipeline workflow. We can first write another abstract class "Builder" that extends earlier "Step" class. </p>

<pre><code class="groovy">package com.rieh.jenkins.build

public abstract class Builder extends com.rieh.jenkins.Step {

    protected abstract void build(Map config)

    protected void execute(Map config) throws Exception {
        build(config)
    }

}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-7">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Builder - MavenBuild</h2>
    <p class="card-text">We can write "MavenBuild" class that extends above "Builder" abstract class. This "MavenBuild" class will implement the abstract "build" method from "Builder" class and abstract "report" method from "Step" class.</p>

<pre><code class="groovy">package com.rieh.jenkins.build.java

    public class MavenBuild extends com.rieh.jenkins.build.Builder {

    public MavenBuild(Object scope, String name) {
        this.scope = scope
        this.name = name
    }

    protected String report(Map config, String status) {
        return com.rieh.jenkins.util.Reporter.simpleReport(name, status)
    }

    protected void build(Map config) throws Exception {
        switch(config.pipeline_version) {
            case "v1":
                buildWithEnv(config)
                break
            case "v2":
                buildWithMaven(config)
                break
            default:
                status = "FAILURE"
        }
    }

}</code></pre>

    <p class="card-text">Here we have the use case of "feature toggle" we've implemented in the "mainMethod". Depending on the version, "MavenBuild" class will execute different method that executes maven build in different way.</p>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-8">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Builder - NodeBuild</h2>
    <p class="card-text">We can also perform npm build just like we did for maven. Following code will remove "node_modules" folder using the pipeline syntax.</p>

<pre><code class="groovy">Boolean result = fileExists "node_modules"
    if (result) {
        dir("node_modules") {
        deleteDir()
    }
}</code></pre>

    <p class="card-text">Then we can run the npm command (config.install_command) passed through configuration after removing the cache folder.</p>
<pre><code class="groovy">private final String NPM_CACHE_FOLDER = '.cache'

String command = """
    if [ -d ${NPM_CACHE_FOLDER} ] ; then
        rm -rf ${NPM_CACHE_FOLDER}
    fi
        mkdir ${NPM_CACHE_FOLDER}
        ${config.install_command} --cache=${NPM_CACHE_FOLDER}
    """
runOsCMD(scope, command)</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-9">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Builder - AngularPackage</h2>
    <p class="card-text">This step shows how to package Angular code into an artifact.</p>

<pre><code class="groovy">def pack = scope.readJSON file: "${currentDirectory}${config.workspace}/package.json"
String artifact = "${pack.name}"
if (scope.isUnix()) {
    command = """
    zip -r target/${artifact}.zip ${config.package_directory} ${config.exclude_string}
"""
    runOsCMD(scope, command)
} else {
    scope.zip dir: '.', glob: '', zipFile: "target/${artifact}.zip"
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-10">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Publisher</h2>

    <p class="card-text">Here we will cover how to do pubish code into artifact repository.</p>

<pre><code class="groovy">package com.rieh.jenkins.publish

public abstract class Publisher extends com.rieh.jenkins.Step {

    protected abstract void publish(Map config)

    protected void execute(Map config) throws Exception {
        publish(config)
    }

}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-11">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Publisher - Maven Publish</h2>
    <p class="card-text">We want to publish artifact during the pipeline workflow. The following shows how to do it with maven in two ways.</p>

<pre><code class="groovy">String toolString = setupTools(config)
scope.withEnv(["PATH+WHATEVER=${toolString}"]) {
    runOsCMD(scope, "${config.maven_command}")
}</code></pre>

<pre><code class="groovy">scope.withMaven(maven: config.maven, globalMavenSettingsConfig: config.global_maven_setting) {
    runOsCMD(scope, "${config.maven_command}")
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-12">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Publisher - Maven Release</h2>
    <p class="card-text">Similar to Maven Publish, we have the following for Maven Release.</p>

<pre><code class="groovy">String credentialId = scope.scm.getUserRemoteConfigs()[0].getCredentialsId()
    scope.sshagent([credentialId]) {
        cleanRelease(config, currentDirectory+config.workspace+"/pom.xml")
        String currentVersion = getCurrentVersion(config, currentDirectory+config.workspace+"/pom.xml")
        String toolString = setupTools(config)
        scope.withEnv(["PATH=WHATEVER=${toolString}"]) {
        runOsCMD(scope, "${config.maven_command} -DreleaseVersion=${currentVersion}")
    }
}</code></pre>

<pre><code class="groovy">String credentialId = scope.scm.getUserRemoteConfigs()[0].getCredentialsId()
    scope.sshagent([credentialId]) {
        cleanRelease(config, currentDirectory+config.workspace+"/pom.xml")
        String currentVersion = getCurrentVersion(config, currentDirectory+config.workspace+"/pom.xml")
        scope.withMaven(maven: config.maven, globalMavenSettingsConfig: config.global_maven_setting) {
        runOsCMD(scope, "${config.maven_command} -DreleaseVersion=${currentVersion}")
    }
}</code></pre>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-13">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Publisher - Angular Publish</h2>
    <p class="card-text">For projects without pom.xml files, we will use "mvm" commands fo publish artifact. For example of Angular, the following can be used.</p>

<pre><code class="groovy">incrementNodeVersion(config)
String command = """
    RELEASE_VERSION=\$(cat package.json | jq -r \'.version\')
    NAME=\$(cat package.json | jq -r \'name\')
    mvn deploy:deploy-file -DgroupId=${config.group_id} -DartifactId=\$NAME -Dversion=\$RELEASE_VERSION -DuniqueVersion=false -Dpackaging=${config.packaging} -DrepositoryId=${config.repository} -Durl=${config.nexus_url}/${config.repository} -Dfile=target/\$NAME.zip -B
"""
runOsCMD(scope, command)</code></pre>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-14">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Deployer</h2>
    <p class="card-text">Here, we will cover various type of depoyment.</p>

<pre><code class="groovy">package com.rieh.jenkins.deploy

    public abstract class Deployer extends com.rieh.jenkins.Step {

    protected abstract void deploy(Map config)

    protected void execute(Map config) throws Exception {
        deploy(config)
    }

}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-15">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Notifier</h2>
    <p class="card-text">Notifying users with build information via scm/email/etc is very useful.</p>

<pre><code class="groovy">package com.rieh.jenkins.notify

public abstract class Notifier extends com.rieh.jenkins.Step {

    protected abstract void notify(Map config)

    protected void execute(Map config) throws Exception {
        notify(config)
    }

    protected boolean sendNotification(Map config) throws Exception {
        config.notification_cases.contains(scope.currentBuild.result) ? true : false
    }

}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-16">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Notifier - SCMNotification</h2>
    <p class="card-text"></p>

<pre><code class="groovy">String state = null
switch(scope.currentBuild.result) {
    case "FAILURE":
        state = "FAILED"
    break
    case "ABORTED":
        state = "STOPPED"
    break
    case "SUCCESS":
        state = "SUCCESSFUL"
    break
    case "UNSTABLE":
        state = "SUCCESSFUL"
    break
}
if (config.in_progress) {
    state = "INPROGRESS"
}
String commitHash = scope.sh returnStdout: true, script: 'git rev-parse HEAD'
String shortCommitHash = scope.sh returnStdout: true, script: 'git rev-parse --short HEAD'
def json = new JSONBuilder([
    name: "${currentBranch} ${buildNumber}",
    state: state,
    key: currentBranch + "-" + shortCommitHash,
    url: scope.env.BUILD_URL
]).toString()
def response = scope.httpRequest authentication: config.notification_scm_account_id, contentType: 'APPLICATION_JSON', httpMode: 'POST, requestBody: json, url: "https://YOUR_BITBUCKET_URL/rest/build-status/1.0/commits/${commitHash}", consoleLogResponseBody: true</code></pre>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-17">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Notifier - EmailNotification</h2>
    <p class="card-text"></p>

<pre><code class="groovy">String report = com.rieh.jenkins.util.Reporter.consolidateReport(scope)
String subject = getSubject(config)
scope.mail bcc: '', body: report, cc: '', from: config.notification_email_sender, reployTo: '', subject: subject, to: config.notification_email_recipients, mimeType: 'text/html'</code></pre>

<pre><code class="groovy">private String getSubject(Map config) throws Exception {
    def priorStatus = scope.currentBuild.getPreviousBuild()?.getResult()
    def currentStatus = scope.currentBuild.result

    String status = null
    if (currentStatus == "SUCCESS" && priorStatus != "SUCCESS") {
        status = "FIXED"
    } else if (priorStatus == "SUCCESS" && currentStatus != "SUCCESS") {
        status = "BROKEN"
    } else {
        status = scope.currentBuild.result
    }

    return config.mal_code + " => " + status
}</code></pre>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-10-18">
  <div class="card-body">
    <h2 class="card-title">Pipeline with Shared Library - Scanner</h2>
    <p class="card-text">Various code scan can also be pipeline steps.</p>

<pre><code class="groovy">package com.rieh.jenkins.scan

public abstract class Scanner extends com.rieh.jenkins.Step {

    protected abstract void scan(Map config)

    protected void execute(Map config) throws Exception {
        scan(config)
    }

}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-11">
  <div class="card-body">
    <h2 class="card-title">Maven and pom.xml</h2>
    <p class="card-text">pom.xml manages dependencies and deployment. An example pom.xml can look like.</p>
<pre><code class="xml">&lt;&amp;xml version="1.0" encoding="UTF-8?"&gt;
&lt;project&gt;
&lt;groupId&gt;&lt;/groupId&gt;
&lt;artifactId&gt;&lt;/artifactId&gt;
&lt;version&gt;&lt;/version&gt;
&lt;packaging&gt;&lt;/packaging&gt;
&lt;name&gt;&lt;/name&gt;

&lt;properties&gt;

&lt;/properties&gt;

&lt;build&gt;
  &lt;pluginManagement&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;&lt;/groupId&gt;
        &lt;artifactId&gt;&lt;/artifactId&gt;
        &lt;version&gt;&lt;/version&gt;
        &lt;configuration&gt;&lt;/configuration&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;id&gt;&lt;/id&gt;
                &lt;goals&gt;
                    &lt;goal&gt;&lt;/goal&gt;
                &lt;/goals&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;&lt;/groupId&gt;
        &lt;artifactId&gt;&lt;/artifactId&gt;
        &lt;version&gt;&lt;/version&gt;
        &lt;configuration&gt;&lt;/configuration&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;id&gt;&lt;/id&gt;
                &lt;goals&gt;
                    &lt;goal&gt;&lt;/goal&gt;
                &lt;/goals&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;&lt;/groupId&gt;
        &lt;artifactId&gt;&lt;/artifactId&gt;
        &lt;version&gt;&lt;/version&gt;
        &lt;configuration&gt;&lt;/configuration&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;id&gt;&lt;/id&gt;
                &lt;goals&gt;
                    &lt;goal&gt;&lt;/goal&gt;
                &lt;/goals&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/pluginManagement&gt;
&lt;/build&gt;

&lt;distributionManagement&gt;
  &lt;repository&gt;
    &lt;id&gt;&lt;/id&gt;
    &lt;url&gt;&lt;/url&gt;
  &lt;/repository&gt;
  &lt;snapshotRepository&gt;
    &lt;id&gt;&lt;/id&gt;
    &lt;url&gt;&lt;/url&gt;
  &lt;/snapshotRepository&gt;
&lt;/distributionManagement&gt;

&lt;scm&gt;
  &lt;url&gt;&lt;/url&gt;
  &lt;connection&gt;&lt;/connection&gt;
  &lt;developerConnection&gt;&lt;/developerConnection&gt;
  &lt;tag&gt;&lt;/tag&gt;
&lt;/scm&gt;</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-12">
  <div class="card-body">
    <h2 class="card-title">Common Jenkins pipeline issues and resolutions</h2>
    <p class="card-text"><strong>1. Maven release - unables to tag scm</strong><br/>Check if the tag generated by pomx.xml already exists in the remote. If it exists, delete the tag in the remote by executing "git push origin --delete [tagname]"</p>
    <p class="card-text"><strong>2. User not able to execute commands</strong><br/>Check if the "user" executing the command is part of one of the groups added to one of the files under "/etc/sudoers.d". If so yet still cannot execute commands, refresh the configuration on the vm (In case of Salt, it would be sudo salt-call state.highstate)</p>
    <p class="card-text"><strong>3. Permission denied (public key)</strong><br/>Go to Jenkins job configuration -> git congiration, and select user that has access to Code Repository</p>
    <p class="card-text"><strong>4. Maven release - 401 Unauthorized</strong><br/>Review credentials in "settings.xml" under JENKINS_HOME/.m2 of the Jenkins agent on which the job is running</p>
    <p class="card-text"><strong>5. Host key verification failed</strong><br/>Go to the Jenkins agent and replace the host key by executing "ssh-keygen -R [IP_ADDRESS]" and "ssh-keyscan -H >> ~/.ssh/known_hosts"</p>
    <p class="card-text"><strong>6. Unables to commit files / git-push command failed</strong><br/>In the Code Repository settings, check if direct push to certain branches are disabled. Watch for plugins like "Yet Another Commit Checker", which denies commits that don't follow certain message pattern</p>
    <p class="card-text"><strong>7. Maven release - 400 Bad Request</strong><br/>Check if the artifact with same group id, artifact id, and version already exists in Artifact Repository. If so, increment the version of try again</p>
    <p class="card-text"><strong>8. Multibranch pipeline scan fails with "unable to resolve reference"</strong><br/>Under JENKINS_HOME/cashes of Jenkins master, there are directories whose names are hash strings. Scan the Multibranch pipeline job, order directories under JENKINS_HOME/cashes by timestamp, go into few folders with the latest timestamps. and execute "git branch -a" to see if it the repo you are looking for. Remove the folder upon finding it</p>
    <p class="card-text"><strong>9. Failed to fetch from ssh</strong><br/>It is likely that the Code Repository is too big and Jenkins cannot finish cloning before timeout occurs. Go to Git Configuration -> Additional Behaviors -> Timeout (in minutes) for clone and fetch operations. Increase the timeout</p>
    <p class="card-text"><strong>10. SonarQube Error - is already part of project</strong><br/>SonarQube identifies each project by its key. Key is constructed by the combination of group id and artifact id of the module itself and its parent module. When SonarQube sees duplicate keys, it gets confused and cannot perform analysis. Potetial cause of this problem is moving sub-modules from one project to another without updating sub-module's pom.xml. In such case, pom.xml of the sub-module(s) must be updated with the correct group id(s) and artifact id(s)</p>
    <p class="card-text"><strong>11. groovy.lang.MissingPropertyException</strong><br/>It is likely that there is syntax error in "Jenkinsfile"</p>
    <p class="card-text"><strong>12. No such file or directory</strong><br/>Check if "checkout scm" step is missing from "Jenkinsfile"</p>
    <p class="card-text"><strong>13. WorkflowScript: Loading libraries failed</strong><br/>From Jenkins, go to Configure System -> Global Pipeline Lbraries. Check the authentication of your library</p>
    <p class="card-text"><strong>14. mvn: command not found</strong><br/>From Jenkins, go to Global Tool Configuration -> Maven -> Maven Installation. Find the name of the tool and use that name for Tool Locations of Jenkins Agent Configuration</p>
    <p class="card-text"><strong>15. HEAD is not a symbolic ref</strong><br/>From Git Configuration, set "Check out to matching local branch"</p>
    <p class="card-text"><strong>16. Maven release is happening twice</strong><br/>Visit "maven-release-plugin" section of pom.xml and make sure it has right configuration and execution sections</p>
    <p class="card-text"><strong>17. SOA Tests cannot execute</strong><br/>THe project name in ".project" file has to match the name of folder where SOA test suites are located</p>
  </div>
  <div class="card-footer text-muted">

  </div>
</div>

<div class="card mb-4" id="jenkins-13">
  <div class="card-body">
    <h2 class="card-title">Jenkins job DSL scripts</h2>
    <p class="card-text">Writing Jenkins job as code gives strong advantages - jobs will be backed up in a form of code in Repository and they are easily reproducible. The following "createAllJobs.groovy" can be used as an example.</p>

<pre><code class="groovy">import com.rieh.dsl.JobDSLUtils

/**
* To add a folder in Jenkins, just add a folder name to the "folders" list
*/
def folders = [
"PROJECT-1",
"PROJECT-2",
"PROJECT-3"
]
JobDSLUtils.createFOlder(this, folder)

/**
* To add a multi-branch pipeline job in Jenkins, follow this guideline
* 1st item: add name of the job including its path
* 2nd item: add git clone url
* 3rd item: add ID of Credential stored in Jenkins that has read-access to the git repository
* 4th item: if you only want to build particular branches, include them in this list. Otherwise, leave it empty
*/
def multiBranchJobs = [
["PROJECT-1", "project-1-git-clone-url", "sshkey-for-project-1", ["branch-1-for-project-1"]],
["PROJECT-2", "project-2-git-clone-url", "sshkey-for-project-2", []]
["PROJECT-3", "project-3-git-clone-url", "sshkey-for-project-3", []]
]
JobDSLUtils.createMultibranchPipelineJob(this, multiBranchJobs)</code></pre>

    <p class="card-text">JobDSLUtils.groovy can look like</p>

<pre><code class="groovy">package com.rieh.dsl

class JobDSLUtils {
    static void createFolder(Object context, List folders) {
    context.with {
        folders.each { item ->
            folder(item)
        }
    }
}

static void createMultibranchPipelineJob(Object context, List jobs) {
    context.with {
        jobs.each { job ->
            String jobName = job[0]
            String gitCloneUrl = job[1]
            String credential = job[2]
            List branchesToPull = job[3]
            multibranchPipelineJob(jobName) {
                branchSources {
                    git {
                        remote(gitCloneUrl)
                        credentialsId(credential)
                        if (branchesToPull.size() > 0) {
                            String branches = ""
                            branchesToPull.each { branch ->
                                branches += branch
                                branches += " "
                            }
                            branches = branches.substring(0, branches.length() - 1)
                            includes(branches)
                        }
                    }
                }
                orphanedItemStrategy {
                    discardOldItem {
                        numToKeep(10)
                    }
                }
            }
        }
    }
}</code></pre>

  </div>
  <div class="card-footer text-muted">

  </div>
</div>
<!-- Jenkins END -->

</div> <!-- /.col-md-12 -->
</div> <!-- /.row -->
</div> <!-- /.container -->

<include src="footer.html"></include>

</body>

</html>