<!DOCTYPE html>

<html lang="en">

<head>

<!-- Metadata -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="Seungmoon Rieh">
<meta name="keywords" content="">

<!-- Title and image -->
<title>Seungmoon Rieh</title>
<link href="/img/seungmoonrieh.jpg" rel="icon">

<!-- CSS -->
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/monokai-sublime.css" rel="stylesheet">
<link href="/css/site.css" rel="stylesheet">

<!-- JavaScript -->
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/highlight.pack.js"></script>
<script type="text/javascript" src="/js/include_html.js"></script>
<script type="text/javascript" src="/js/site.js"></script>

</head>

<body>

<include src="/header.html"></include>

<div class="container">
<div class="row">
<div class="col-md-12">
<h1 class="my-4">Infrastructure DevOps</h1>

<!-- Elasticsearch BEGIN -->
<div class="card mb-4" id="elasticsearch">
  <div class="card-body">
    <h2 class="card-title">Elasticsearch</h2>
    <p class="card-text"></p>
    <ul class="list-unstyled mb-0">
      <li><a href="#elasticsearch-1">Elasticsearch</a></li>
      <li><a href="#elasticsearch-2">Endpoint</a></li>
      <li><a href="#elasticsearch-3">Node role</a></li>
      <li><a href="#elasticsearch-4">Multizone cluster with helm chart</a></li>
    </ul>
  </div>
</div>

<div class="card mb-4" id="elasticsearch-1">
  <div class="card-body">
    <h2 class="card-title">Elasticsearch</h2>
    <ul>
      <li>Automatically handles partitioning documents into shards, which are stored on multiple nodes.</li>
    </ul>

    <h3 class="card-title">Indices</h3>

<p class="card-text">SQL -> Database -> Table -> Row/Column</p>
<p class="card-text">Elasticsearch -> Index -> Type -> Document/Property</p>

  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://www.elastic.co/blog/what-is-an-elasticsearch-index">What is an Elasticsearch Index?</a> | <a href="https://www.instaclustr.com/blog/understanding-and-configuring-elasticsearch-node-types/">Elasticsearch Basics</a>
  </div>
</div>

<div class="card mb-4" id="elasticsearch-2">
  <div class="card-body">
    <h2 class="card-title">Endpoint</h2>

    <h3 class="card-title">General</h3>

<pre><code class="bash"># Check cluster health.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cluster/health?pretty

# View available API endpoints.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat

# Create an API key.
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_security/api_key --header "Content-Type: application/json" --date '{}'
apiKey=&lt;encoded_api_key_from_above&gt;</code></pre>

    <h3 class="card-title">License</h3>

<pre><code class="bash"># Check license.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_license

# Update licese. (With the license in "license.json" file)
curl -k -u &lt;username&gt;:&lt;password&gt; -X PUT https://&lt;endpoint&gt;/_license -H "Content-Type: application/json" -d @license.json</code></pre>

    <h3 class="card-title">Index</h3>

<pre><code class="bash"># List all indices.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat/indices?v

# List few indices.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat/indices/&lt;index_name_1&gt;,&lt;index_name_2&gt;,&lt;index_name_3&gt;?v

# Create an index.
curl -k -H "Authorization: ApiKey $apiKey" -X PUT https://&lt;endpoint&gt;/&lt;index_name&gt;

# Get an index.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;?pretty

# Check index setting.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;/_setting?pretty

# Update index setting.

# For example, temporarily setting number_of_replicas to 0 and refresh_interval to -1 (This disable reflecing written documents in index to users) is helping during the inital data load on index for it will speed up the indexing.
curl -k -u &lt;username&gt;:&lt;password&gt; -X PUT https://&lt;endpoint&gt;/&lt;index_name&gt;/_settings?pretty -H "Content-Type: application/json" -d '
{
  "index": {
    "number_of_replicas": 0,
    "refresh_interval": -1
  }
}'

# To revert the index setting "refresh_interval" to default.
curl -k -u &lt;username&gt;:&lt;password&gt; -X PUT https://&lt;endpoint&gt;/&lt;index_name&gt;/_settings?pretty -H "Content-Type: application/json" -d '
{
  "index": {
    "refresh_interval": null
  }
}'</code></pre>

    <h3 class="card-title">Mapping</h3>

<pre><code class="bash"># View mapping of an index.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;/_mapping?pretty</code></pre>

    <h3 class="card-title">Document</h3>

<pre><code class="bash"># Create a document.
curl -k -H "Authorization: ApiKey $apiKey" -H "Content-Type: application/json" -X PUT https://&lt;endpoint&gt;/&lt;index_name&gt;/_doc/&lt;document_id&gt; -d '&lt;JSON&gt;'

# Check a document.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;/_doc/&lt;document_id&gt;

# Count the number of documents in an index.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;/_count?pretty

# Count the number of documents matching a query.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;/_count?pretty -H "Content-Type: application/json" -d '
{
  "query": {
    "term": {
      "field in the document": "value"
    }
  }
}'

# Count the number of documents matching a ranged query.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/&lt;index_name&gt;/_count?pretty -H "Content-Type: application/json" -d '
{
  "query": {
    "range": {
      "field in the document": {
        "gte": "from value",
        "lte": "to value"
      }
    }
  }
}'</code></pre>

    <h3 class="card-title">Snapshot</h3>
    <ul>
      <li>The location of snapshot repo must exist.</li>
      <ul>
        <li>It can be local directory only if single node cluster.</li>
        <li>It must be shared network directory if multi node cluster.</li>
        <li>User "elasticsearch" must have write permission to this location.</li>
      </ul>
      <li>All nodes in the cluster must have "path.repo: &lt;snapshot_repo_location&gt;" in <code>elasticsearch.yml</code></li>
      <li><font color="#ff0000">Warning!</font> If using snapshot for data migration from one verison of Elasticsearch to another, migrated indices may not be readable/writable from the new cluster! (Reindex should be considered)</li>
    </ul>

<pre><code class="bash"># List snapshot repositories.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_snapshot?pretty

# List snapshots in a snapshot repository.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat/snapshots/&lt;snapshot_repo_name&gt;?pretty
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat/snapshots/&lt;snapshot_repo_name&gt;/_status?pretty

# Create snapshot repository.
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_snapshot/&lt;snapshot_repo_name&gt; -H "Content-Type: application/json" -d '
{
  "type": "fs",
  "settings": {
    "location": "/path/to/directory"
  }
}'

# Create a snapshot. (All indices)
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_snapshot/&lt;snapshot_repo_name&gt;/&lt;snapshot_name&gt;?wait_for_completion=true&pretty
# Create a snapshot. (Specific indices)
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_snapshot/&lt;snapshot_repo_name&gt;/&lt;snapshot_name&gt;?wait_for_completion=true&pretty -d '{ "indices": "index1, index2" }'

# Restore from a snapshot.
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_snapshot/&lt;snapshot_repo_name&gt;/&lt;snapshot_name&gt;/_restore?wait_for_completion=true&pretty</code></pre>

    <h3 class="card-title">Reindex</h3>
    <ul>
      <li>Used when copying document from one index to another index.</li>
      <pre><code class="bash">curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_reindex?wait_for_completion=false -H "Content-Type: application/json" -d '
{
  "source": {
    "index": "source_index"
  }, "
  dest": {
    "index": "dest_index"
  }
}'</code></pre>
      <li>Used when copying index from one version of Elasticsearch to another version of Elasticsearch. All nodes in the remote cluster must have "reindex.remote.whitelist: &lt;remote_cluster_url&gt;" in <code>elasticsearch.yml</code></li>
      <pre><code class="bash">curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_reindex?wait_for_completion=false -H "Content-Type: application/json" -d '
{
  "source": {
    "remote": {
      "host": "https://remote_endpoint",
      "username": "my_username",
      "password": "my_password"
    },
    "index": "source_index"
  },
  "dest": {
    "index": "dest_index"
  }
}'</code></pre>
      <li>Ranged query can be used to re-index documents whose field has a value under certain range. (For example, between dates)</code></li>
      <pre><code class="bash">curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_reindex?wait_for_completion=false -H "Content-Type: application/json" -d '
{
  "source": {
    "remote": {
      "host": "https://remote_endpoint",
      "username": "my_username",
      "password": "my_password"
    },
    "index": "source_index",
    "query": {
      "range": {
        "field in the document": {
          "gte": "from value",
          "lte": "to value"
        }
      }
    }
  },
  "dest": {
    "index": "dest_index"
  }
}'</code></pre>
      <li><code>size</code> represents the number of documents in each batch. If each batch is greater than 100MB, Elasticsearch will report an error. This error needs to be handled by descreasing the number of documents in each batch so that the while batch does not exceed 100MB.</li>
      <pre><code class="bash">curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_reindex?wait_for_completion=false -H "Content-Type: application/json" -d '
{
  "source": {
    "remote": {
      "host": "https://remote_endpoint",
      "username": "my_username",
      "password": "my_password"
    },
    "index": "source_index",
    size: 100
  },
  "dest": {
    "index": "dest_index"
  }
}'</code></pre>
      <li><code>slice</code> can be used for parallel process. (This does not work when reindexing from remote cluster!)</li>
      <pre><code class="bash">curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_reindex?slice=100&wait_for_completion=false -H "Content-Type: application/json" -d '
{
  "source": {
    "index": "source_index"
  },
  "dest": {
    "index": "dest_index"
  }
}'</code></pre>
    </ul>

    <h3 class="card-title">Task</h3>

<pre><code class="bash"># List tasks.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_tasks?pretty

# List a specific task.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_tasks/&lt;task_name&gt;?pretty

# Cancel a specific task.
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_tasks/&lt;task_name&gt;/_cancel?pretty</code></pre>

    <h3 class="card-title">Shards</h3>

<pre><code class="bash"># List shards.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat/shards?v</code></pre>

    <h3 class="card-title">Allocation</h3>
    <ul>
      <li>Display disk allocation in each node.</li>
    </ul>

<pre><code class="bash"># List disk allcation.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_cat/allocation?v</code></pre>

    <h3 class="card-title">SSL certificates</h3>

<pre><code class="bash"># List SSL certificates.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_ssl/certificates</code></pre>

    <h3 class="card-title">Role</h3>

<pre><code class="bash"># List role.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_security/role

# Create role. (With all privileges to all indices)
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_security/&lt;role_name&gt; -d '
{
  "indicies": [
    {
      "names": [ "*" ],
      "privileges": [ "all" ]
    }
  ]
}'</code></pre>

    <h3 class="card-title">User</h3>

<pre><code class="bash"># List role.
curl -k -u &lt;username&gt;:&lt;password&gt; -X GET https://&lt;endpoint&gt;/_security/user

# Create role. (With superuser)
curl -k -u &lt;username&gt;:&lt;password&gt; -X POST https://&lt;endpoint&gt;/_security/&lt;user_name&gt; -d '
{
  "password": "mypassword",
  "roles": [ "superuser" ],
  "full_name": "elasticsearch",
  "email": "elasticsearch@gmail.com"
}'</code></pre>
  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://www.elastic.co/guide/index.html">Welcome to Elastic Docs</a>
  </div>
</div>

<div class="card mb-4" id="elasticsearch-3">
  <div class="card-body">
    <h2 class="card-title">Node role</h2>

    <h3 class="card-title">Master</h3>
    <ul>
      <li>Deployment with fixed replicas. (At least 3 for HA)</li>
      <li>Holds metadata: data nodes, location, sharding, data replication.</li>
      <li>Creates/deletes index.</li>
      <li>Tracks nodes in the cluster.</li>
      <li>It is good idea to have nodes that are dedicated to master role only.</li>
      <li>Medium compute, low storage.</li>
    </ul>

    <h3 class="card-title">Data</h3>
    <ul>
      <li>StatefulSets where each instance has PVC.</li>
      <li>Splits indices into shards and replicate information between nodes. (To prevent data loss)</li>
      <li>Types
        <ul>
          <li>data_hot: most recent and frequently searched data, fast read and write. (High compute, low storage)</li>
          <li>data_warm: typically holds data from recent weeks, updates are infrequent. (Medium compute, medium storage)</li>
          <li>data_cold: data is still searchable but node is optimized for lower storage cost than search speed. (Low compute, high storage)</li>
          <li>data_frozen: data is queried very rarely. Requires snapshot repository. (Minimal compute, enough storage to handle snapshots)</li>
        </ul>
      </li>
    </ul>

    <h3 class="card-title">Ingest</h3>
    <ul>
      <li>Pre-precess documents before they are indexed. (Can be used instead of Logstash)</li>
    </ul>

  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html">Node</a>
  </div>
</div>

<div class="card mb-4" id="elasticsearch-4">
  <div class="card-body">
    <h2 class="card-title">Multizone cluster with helm chart</h2>

    <h3 class="card-title">Master (values.yaml)</h3>
<pre><code class="yaml">---
clusterName: "elasticsearch"
nodeGroup: "master"

esConfig:
  elasticsearch.yml: |
    path.repo: path/to/snapshot_repo

roles:
  - master

secret:
  enabled: true
  password: password-for-default-user-elastic

image: image-name
imageTag: image-tag
imagePullPolicy: "Always"

createCert: true

replicas: 3

resources:
  requests:
    cpu: "1000m"
    memory: "2G1"
  limits:
    cpu: "1000m"
    memory: "2G1"

volumeClaimTemplate:
  accessMode: [ "ReadWriteOnce" ]
  storageClssName: my-storage-class
  resources:
    requests:
      storage: 30Gi</code></pre>

    <h3 class="card-title">Data (values.yaml)</h3>
<pre><code class="yaml">---
clusterName: "elasticsearch"
nodeGroup: "datahot" # Could be datawarm, datacold, datafrozen

esConfig:
  elasticsearch.yml: |
    path.repo: path/to/snapshot_repo

roles:
  - data
  - data_content
  - data_hot # Could be data_warm, data_cold, data_frozen
  - ingest

secret:
  enabled: true

image: image-name
imageTag: image-tag
imagePullPolicy: "Always"

# Use certificate created by master nodes.
createCert: false
secretMounts:
  - name: elastic-certificates
    secretName: elasticsearch-master-certs
    path: /usr/share/elasticsearch/config/certs

replicas: 3

resources:
  requests:
    cpu: "1000m"
    memory: "2G1"
  limits:
    cpu: "1000m"
    memory: "2G1"

volumeClaimTemplate:
  accessMode: [ "ReadWriteOnce" ]
  storageClssName: my-storage-class
  resources:
    requests:
      storage: 30Gi

extraEnvs:
  # Use password created by master nodes.
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elasticsearch-master-credentials
        key: password
  - name: xpack.security.enabled
    value: "true"
  - name: xpack.security.transport.ssl.enabled
    value: "true"
  - name: xpack.security.http.ssl.enabled
    value: "true"
  - name: xpack.security.transport.ssl.verification.mode
    value: "certificate"
  - name: xpack.security.transport.ssl.key
    value: "/usr/share/elasticsearch/config/certs/tls.key"
  - name: xpack.security.transport.ssl.certificate
    value: "/usr/share/elasticsearch/config/certs/tls.crt"
  - name: xpack.security.transport.ssl.certificate_authorities
    value: "/usr/share/elasticsearch/config/certs/ca.cert"
  - name: xpack.security.http.ssl.key
    value: "/usr/share/elasticsearch/config/certs/tls.key"
  - name: xpack.security.http.ssl.certificate
    value: "/usr/share/elasticsearch/config/certs/tls.crt"
  - name: xpack.security.http.ssl.certificate_authorities
    value: "/usr/share/elasticsearch/config/certs/ca.crt"</code></pre>

  </div>
  <div class="card-footer text-muted">
    Reference: <a href="https://github.com/elastic/helm-charts/tree/main/elasticsearch/examples/multi">elastic/helm-charts</a>
  </div>
</div>
<!-- Elasticsearch END -->

</div> <!-- /.col-md-12 -->
</div> <!-- /.row -->
</div> <!-- /.container -->

<include src="/footer.html"></include>

</body>

</html>